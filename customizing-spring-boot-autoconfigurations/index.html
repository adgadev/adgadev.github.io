<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="/adgadev/">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://adgadev.com/img/bg/simon-berger-t6zocP52Fg0-unsplash.jpg">
    <meta property="twitter:image" content="https://adgadev.com/img/bg/simon-berger-t6zocP52Fg0-unsplash.jpg" />
    

    
    <meta name="title" content="Extending and customizing auto-configuration classes provided by Spring Boot" />
    <meta property="og:title" content="Extending and customizing auto-configuration classes provided by Spring Boot" />
    <meta property="twitter:title" content="Extending and customizing auto-configuration classes provided by Spring Boot" />
    

    
    <meta name="description" content="adgadev">
    <meta property="og:description" content="adgadev" />
    <meta property="twitter:description" content="adgadev" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="adgadev, JPlusOne">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Extending and customizing auto-configuration classes provided by Spring Boot-Adam Gaj Blog</title>

    <link rel="canonical" href="/customizing-spring-boot-autoconfigurations">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>
	
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">
    
    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    
    <link rel="stylesheet" href="https://adgadev.com/css/custom.css"><link rel="stylesheet" href="https://adgadev.com/css/base16.dark.css">

    
    
    <script src="/js/jquery.min.js"></script>
    
    
    <script src="/js/bootstrap.min.js"></script>
    
    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>



<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">/adgadev/</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/blog">blog</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/about/">ABOUT</a></li>
                    

                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/bg/maxime-lebrun-cTFSEWejQHE-unsplash.jpg')
    }
</style>
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/java" title="Java">
                            Java
                        </a>
                        
                        <a class="tag" href="/tags/spring-boot" title="Spring Boot">
                            Spring Boot
                        </a>
                        
                    </div>
                    <h1>Extending and customizing auto-configuration classes provided by Spring Boot</h1>
                    <h2 class="subheading">How to dynamically exclude selected Spring Boot auto-configuration classes using profile groups</h2>
                    <span class="meta">
                        Posted by 
                        
                            Adam Gaj
                         
                        on 
                        Friday, August 26, 2022
                        
                        
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                post-container">

                
                
<div class="sect1">
<h2 id="_problem_statement">Problem statement</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Imagine a scenario when we need to enable certain spring boot auto-configuration on a subset of environments only. The reason for that may be that i.e. our new feature will use new database (mongo) which hasn’t been setup on all environments yet for some reason, but we don’t want this issue to stop us from deploying new version of the application.</p>
</div>
<div class="paragraph">
<p>Not all spring boot auto-configurations support disabling them using property. We could try to exclude auto-configurations by declaring them in <code>exclusions</code> property of <code>@SpringBootApplication</code> and later import these auto-configurations using <code>@Import</code> or <code>@ImportAutoConfiguration</code> in profile specific configuration. Unfortunately this approach often does not work. Basically mixing auto-configuration and manual imports often leads to hard to diagnose configuration errors. Fortunately there is a better way which is purely based on auto-configuration.</p>
</div>
<div class="sect2">
<h3 id="_profile_groups">Profile groups</h3>
<div class="paragraph">
<p>Spring boot 2.4 introduced concept of &#39;profile groups&#39; which allows expanding single profile into multiple sub-profiles.
We can use profile groups to map a single profile identifying environment where application is running (<code>dev</code> / <code>stage</code> / <code>prod</code>) to set of features which are enabled at each environment.
In order to use profile groups we need to define <code>spring.profiles.group</code> section in  <code>application.yml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">spring</span><span class="pi">:</span>
  <span class="na">profiles</span><span class="pi">:</span>
    <span class="na">group</span><span class="pi">:</span>
      <span class="na">dev</span><span class="pi">:</span> <span class="s">bravo, halo</span>
      <span class="na">prod</span><span class="pi">:</span> <span class="s">bravo</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Such setup will result in having active profiles: <code>dev</code>, <code>bravo</code>, <code>halo</code> on <code>dev</code> environment. On <code>prod</code> environment only <code>prod</code> and <code>bravo</code> profiles will be active.</p>
</div>
</div>
<div class="sect2">
<h3 id="_feature_specific_auto_configuration">Feature specific auto-configuration</h3>
<div class="paragraph">
<p>In our case we will be building a feature based on mongoDb. When feature is disabled, the application should not require mongo database to exist nor utilize any mongo auto-configurations, since it’s the only feature using mongodb in our app. Apart from that all services, controllers and other application spring beans related with this feature should be created only when feature is enabled.</p>
</div>
<div class="paragraph">
<p>For start, we need to define annotation which will allow binding feature specific components &amp; configurations with a dedicated spring profile.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Profile</span><span class="o">(</span><span class="s">&#34;halo&#34;</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">HaloFeature</span> <span class="o">{</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next thing is to add auto-configuration’s condition which will allow enabling feature specific auto-configurations when feature profile is active:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">class</span> <span class="nc">HaloProfileCondition</span> <span class="kd">implements</span> <span class="nc">Condition</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Profiles</span> <span class="no">HALO_PROFILE</span> <span class="o">=</span> <span class="nc">Profiles</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;halo&#34;</span><span class="o">);</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span><span class="nc">ConditionContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">AnnotatedTypeMetadata</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">getEnvironment</span><span class="o">().</span><span class="na">acceptsProfiles</span><span class="o">(</span><span class="no">HALO_PROFILE</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are three mongo related auto-configurations used by our application. They need to be made conditional. Let’s create new auto-configuration classes which are subclasses of original auto-configurations and annotate them with <code>@Conditional</code> utilizing feature condition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Configuration</span>
<span class="nd">@Conditional</span><span class="o">(</span><span class="nc">HaloProfileCondition</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">HaloMongoAutoConfiguration</span> <span class="kd">extends</span> <span class="nc">MongoAutoConfiguration</span> <span class="o">{</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Configuration</span>
<span class="nd">@Conditional</span><span class="o">(</span><span class="nc">HaloProfileCondition</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">HaloMongoDataAutoConfiguration</span> <span class="kd">extends</span> <span class="nc">MongoDataAutoConfiguration</span> <span class="o">{</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Configuration</span>
<span class="nd">@Conditional</span><span class="o">(</span><span class="nc">HaloProfileCondition</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">HaloMongoRepositoriesAutoConfiguration</span> <span class="kd">extends</span> <span class="nc">MongoRepositoriesAutoConfiguration</span> <span class="o">{</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately this is not sufficient since spring boot conditional rules are not being inherited by subclasses. Hence, conditional rules has to be copied from <code>MongoAutoConfiguration</code>, <code>MongoDataAutoConfiguration</code> and <code>MongoRepositoriesAutoConfiguration</code> to their subclasses.</p>
</div>
<div class="paragraph">
<p>The other thing is that dependencies declared in <code>@AutoConfigureAfter</code> / <code>@AutoConfigureBefore</code> should refer to auto-configuration classes, not their subclasses. Otherwise, they won’t work. That’s why these annotations has to be copied from superclass to subclasses, but this time values inside annotations has to be replaced with corresponding <code>Halo*AutoConfiguration</code> classes.</p>
</div>
<div class="paragraph">
<p>Other spring’s annotations used in auto-configuration subclasses like i.e. <code>@Import</code> or <code>@EnableConfigurationProperties</code> will work as if they were part of subclass auto-configuration, so there is no need to copy them from subclass.</p>
</div>
<div class="paragraph">
<p>After applying these changes we get following auto-configuration classes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Configuration</span>
<span class="nd">@Conditional</span><span class="o">(</span><span class="nc">HaloProfileCondition</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ConditionalOnClass</span><span class="o">(</span><span class="nc">MongoClient</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="s">&#34;org.springframework.data.mongodb.MongoDatabaseFactory&#34;</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">HaloMongoAutoConfiguration</span> <span class="kd">extends</span> <span class="nc">MongoAutoConfiguration</span> <span class="o">{</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Configuration</span>
<span class="nd">@Conditional</span><span class="o">(</span><span class="nc">HaloProfileCondition</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ConditionalOnClass</span><span class="o">({</span> <span class="nc">MongoClient</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">MongoTemplate</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="nd">@AutoConfigureAfter</span><span class="o">(</span><span class="nc">HaloMongoAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">HaloMongoDataAutoConfiguration</span> <span class="kd">extends</span> <span class="nc">MongoDataAutoConfiguration</span> <span class="o">{</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Configuration</span>
<span class="nd">@Conditional</span><span class="o">(</span><span class="nc">HaloProfileCondition</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ConditionalOnClass</span><span class="o">({</span> <span class="nc">MongoClient</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">MongoRepository</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="nd">@ConditionalOnMissingBean</span><span class="o">({</span> <span class="nc">MongoRepositoryFactoryBean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">MongoRepositoryConfigurationExtension</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="nd">@ConditionalOnRepositoryType</span><span class="o">(</span><span class="n">store</span> <span class="o">=</span> <span class="s">&#34;mongodb&#34;</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="nc">RepositoryType</span><span class="o">.</span><span class="na">IMPERATIVE</span><span class="o">)</span>
<span class="nd">@AutoConfigureAfter</span><span class="o">(</span><span class="nc">HaloMongoDataAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">HaloMongoRepositoriesAutoConfiguration</span> <span class="kd">extends</span> <span class="nc">MongoRepositoriesAutoConfiguration</span> <span class="o">{</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>New auto-configurations have to be registered in <code>META-INF/spring.factories</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="p">=</span><span class="se">\
</span>  <span class="s">com.adgadev.examples.featureflags.infrastructure.halo.HaloMongoAutoConfiguration,</span><span class="se">\
</span>  <span class="s">com.adgadev.examples.featureflags.infrastructure.halo.HaloMongoDataAutoConfiguration,</span><span class="se">\
</span>  <span class="s">com.adgadev.examples.featureflags.infrastructure.halo.HaloMongoRepositoriesAutoConfiguration</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s exclude original mongo auto-configurations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@SpringBootApplication</span><span class="o">(</span><span class="n">exclude</span> <span class="o">=</span> <span class="o">{</span>
        <span class="nc">MongoAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="nc">MongoDataAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="nc">MongoRepositoriesAutoConfiguration</span><span class="o">.</span><span class="na">class</span>
<span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoApplication</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">DemoApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_applying_solution_to_sample_feature">Applying solution to sample feature</h3>
<div class="paragraph">
<p>Having conditional mongo setup in place we can add simple mongo dependant feature called <code>halo</code>. The feature consists of single document, mongo repository and a service. Repository and service beans are created only if the <code>halo</code> feature is enabled.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Getter</span>
<span class="nd">@Document</span><span class="o">(</span><span class="s">&#34;halo&#34;</span><span class="o">)</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HaloEntity</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HaloRepository</span> <span class="o">{</span>

    <span class="nc">HaloEntity</span> <span class="nf">save</span><span class="o">(</span><span class="nc">HaloEntity</span> <span class="n">haloEntity</span><span class="o">);</span>

    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">HaloEntity</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@HaloFeature</span>
<span class="kd">interface</span> <span class="nc">MongoHaloRepository</span> <span class="kd">extends</span> <span class="nc">HaloRepository</span><span class="o">,</span> <span class="nc">MongoRepository</span><span class="o">&lt;</span><span class="nc">HaloEntity</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Service</span>
<span class="nd">@HaloFeature</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HaloService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">HaloRepository</span> <span class="n">haloRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">HaloEntity</span> <span class="nf">addHalo</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">haloEntity</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HaloEntity</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="n">name</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">haloRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">haloEntity</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">HaloEntity</span> <span class="nf">getHalo</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">haloRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">orElseThrow</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There is also spring configuration which enables mongock framework for document migration and explicitly defines mongo repositories package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@HaloFeature</span>
<span class="nd">@Configuration</span>
<span class="nd">@EnableMongock</span>
<span class="nd">@EnableMongoRepositories</span><span class="o">(</span><span class="n">basePackageClasses</span> <span class="o">=</span> <span class="nc">MongoHaloRepository</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">MongoCustomisationsConfig</span> <span class="o">{</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s test how this feature works assuming it’s enabled only on dev and mongo database is present there only.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yml"><span class="na">spring</span><span class="pi">:</span>
  <span class="na">profiles</span><span class="pi">:</span>
    <span class="na">group</span><span class="pi">:</span>
      <span class="na">dev</span><span class="pi">:</span> <span class="s">halo</span>
      <span class="na">prod</span><span class="pi">:</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Test is very simple. It creates mongo database using testcontainers, starts spring context and tests <code>haloService</code> in such environment. The test is green when executed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Testcontainers</span>
<span class="nd">@SpringBootTest</span>
<span class="nd">@ActiveProfiles</span><span class="o">(</span><span class="s">&#34;dev&#34;</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">DevProfileDemoApplicationTest</span> <span class="o">{</span>

    <span class="nd">@Container</span>
    <span class="kd">static</span> <span class="nc">MongoDBContainer</span> <span class="n">mongoDBContainer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MongoDBContainer</span><span class="o">(</span><span class="s">&#34;mongo:4.4.2&#34;</span><span class="o">);</span>

    <span class="nd">@DynamicPropertySource</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setProperties</span><span class="o">(</span><span class="nc">DynamicPropertyRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;spring.data.mongodb.uri&#34;</span><span class="o">,</span> <span class="nl">mongoDBContainer:</span><span class="o">:</span><span class="n">getReplicaSetUrl</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">HaloService</span> <span class="n">haloService</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">shouldExecuteOperationOnMongo</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">HaloEntity</span> <span class="n">haloEntity</span> <span class="o">=</span> <span class="n">haloService</span><span class="o">.</span><span class="na">addHalo</span><span class="o">(</span><span class="s">&#34;some name&#34;</span><span class="o">);</span>
        <span class="n">assertNotNull</span><span class="o">(</span><span class="n">haloService</span><span class="o">.</span><span class="na">getHalo</span><span class="o">(</span><span class="n">haloEntity</span><span class="o">.</span><span class="na">getId</span><span class="o">()));</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Test for prod env shows that application context starts successfully, despite the fact that there is no mongo database configured. None mongo or halo related spring been is constructed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@SpringBootTest</span>
<span class="nd">@ActiveProfiles</span><span class="o">(</span><span class="s">&#34;prod&#34;</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">ProdProfileDemoApplicationTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">contextLoads</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same test, but with <code>halo</code> feature enabled fails on spring context creation, due to connectivity issues to mongo database when instantiating mongock’s beans.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">properties</span> <span class="o">=</span> <span class="s">&#34;spring.profiles.group.prod=halo&#34;</span><span class="o">)</span>
<span class="nd">@ActiveProfiles</span><span class="o">(</span><span class="s">&#34;prod&#34;</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">ProdProfileDemoApplicationTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">contextLoads</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The full source code of the examples is available <a href="https://github.com/adgadev/blog-examples/tree/master/spring-boot-feature-flags">here</a>.</p>
</div>
</div>
</div>


                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="finding-origin-and-context-of-jpa-issued-sql-statemets" data-toggle="tooltip" data-placement="top" title="Finding origin and context of JPA issued SQL statements">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                </ul>

                
<div id="disqus-comment"></div>

<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "adgadev" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



            </div>
            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/java" title="java">
                            java
                        </a>
                        
                        
                        
                        <a href="/tags/jpa" title="jpa">
                            jpa
                        </a>
                        
                        
                        
                        <a href="/tags/jplusone" title="jplusone">
                            jplusone
                        </a>
                        
                        
                        
                        <a href="/tags/n&#43;1-select-problem" title="n&#43;1-select-problem">
                            n&#43;1-select-problem
                        </a>
                        
                        
                        
                        <a href="/tags/performance" title="performance">
                            performance
                        </a>
                        
                        
                        
                        <a href="/tags/spring-boot" title="spring-boot">
                            spring-boot
                        </a>
                        
                        
                        
                        <a href="/tags/sql" title="sql">
                            sql
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="/adgadev/" >
                           <span class="fa-stack fa-lg">
                               <i class="fa fa-circle fa-stack-2x"></i>
                               <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
                   
                    
                    <li>
                        <a href="mailto:adgadev@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    <li>
                        <a href="https://twitter.com/adgadev">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    

                    

		    
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/adgadev">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://stackoverflow.com/users/14231619">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
            
                    
                    
                    
            
            
            
                </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Adam Gaj 2022
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-183852793-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</body>
</html>
